pipeline {
    agent {
        kubernetes {
            yamlFile 'Pipelines/CI/kaniko-agent.yaml'
        }
    }

    environment {
        IMAGE_NAME = 'app-nodejs'
        IMAGE_TAG = 'latest'
        REGISTRY_URL = 'docker.io/alaa872/'
        AWS_REGION = 'us-east-1'
        SECRET_NAME = 'dockerhubcredentials'
        GIT_REPO_URL = 'https://github.com/mahmoud254/jenkins_nodejs_example'
        GIT_BRANCH = 'rds_redis'
    }

    stages {
        stage('Checkout Code') {
            steps {
                container('jnlp') {
                    script {
                        echo "Cloning repository from ${env.GIT_REPO_URL} branch ${env.GIT_BRANCH}"
                        git url: env.GIT_REPO_URL, branch: env.GIT_BRANCH
                        sh 'ls -la' 
                    }
                }
            }
        }

        stage('Fetch Docker Hub Credentials') {
            steps {
                container('jnlp') {
                    script {
                        echo "Fetching Docker Hub credentials from AWS Secrets Manager"
                        withAWS(credentials: 'aws-credentials-id', region: env.AWS_REGION) {
                            def secret = awsSecretsManager(secrets: [[name: env.SECRET_NAME, versionStage: 'AWSCURRENT']])
                            withCredentials([usernamePassword(credentialsId: 'dockerhubcredentials', usernameVariable: 'DOCKER_USERNAME', passwordVariable: 'DOCKER_PASSWORD', secret: secret)]) {
                                echo "DOCKER_USERNAME: ${env.DOCKER_USERNAME}"
                                echo "DOCKER_PASSWORD: ${env.DOCKER_PASSWORD}"
                            }
                        }
                    }
                }
            }
        }

        stage('Build Docker Image') {
            steps {
                container('kaniko') {
                    script {
                        echo "Starting Docker build process"
                        echo "Dockerfile path: dockerfile"
                        echo "Context path: /workspace"
                        echo "Destination: ${env.REGISTRY_URL}${env.IMAGE_NAME}:${env.IMAGE_TAG}"

                        sh """
                        /kaniko/executor --dockerfile=dockerfile --context=/workspace --destination=${env.REGISTRY_URL}${env.IMAGE_NAME}:${env.IMAGE_TAG} --verbosity=debug
                        """
                    }
                }
            }
        }
    }
}